<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>„Ç¢„É≥„Ç∞„É©„ÉºË®∫Êñ≠</title>
    <style>
        body { background: #000b1a; color: #00ffff; text-align: center; font-family: sans-serif; margin: 0; padding: 10px; }
        h1 { font-size: 1.4rem; margin: 10px 0; }
        .container { position: relative; width: 280px; height: 350px; margin: 0 auto; background: #000; border: 2px solid #00ffff; border-radius: 10px; overflow: hidden; }
        video, canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
        canvas { display: none; z-index: 5; }
        .scan-line { position: absolute; top: 0; left: 0; width: 100%; height: 3px; background: #fff; box-shadow: 0 0 10px #00ffff; z-index: 10; display: none; animation: scan 1.5s infinite; }
        @keyframes scan { 0% { top: 0; } 50% { top: 100%; } 100% { top: 0; } }
        .btn { background: #ff4136; color: #fff; padding: 12px 30px; border-radius: 50px; border: none; font-weight: bold; margin-top: 15px; cursor: pointer; }
        .result-overlay { position: absolute; bottom: 0; left: 0; width: 100%; background: rgba(0, 0, 0, 0.7); color: #fff; padding: 10px; font-size: 0.8rem; text-align: left; box-sizing: border-box; z-index: 15; display: none; border-top: 1px solid #00ffff; white-space: pre-wrap; }
    </style>
</head>
<body>
    <h1>üé£ „Ç¢„É≥„Ç∞„É©„ÉºË®∫Êñ≠</h1>
    
    <div class="container">
        <video id="video" autoplay playsinline muted></video>
        <canvas id="canvas"></canvas>
        <div id="scanLine" class="scan-line"></div>
        <div id="resultOverlay" class="result-overlay"></div>
    </div>

    <button id="snap" class="btn">ÈÅ©Ê≠£„Çí„Çπ„Ç≠„É£„É≥</button>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const resultOverlay = document.getElementById('resultOverlay');
        const scanLine = document.getElementById('scanLine');
        const snapBtn = document.getElementById('snap');

        // Èü≥Â£∞ÂêàÊàê„ÅÆÊ∫ñÂÇô
        function speak(text) {
            const uttr = new SpeechSynthesisUtterance(text);
            uttr.lang = 'ja-JP';
            uttr.rate = 1.0; // ÈÄüÂ∫¶
            uttr.pitch = 1.0; // Â£∞„ÅÆÈ´ò„Åï
            window.speechSynthesis.speak(uttr);
        }

        navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } }).then(s => {
            video.srcObject = s;
            video.play();
        });

        snapBtn.addEventListener('click', () => {
            // Ë®∫Êñ≠ÈñãÂßã„ÅÆÈü≥Â£∞
            speak("„Çπ„Ç≠„É£„É≥„ÇíÈñãÂßã„Åó„Åæ„Åô„ÄÇÂãï„Åã„Å™„ÅÑ„Åß„Åè„Å†„Åï„ÅÑ„ÄÇ");
            
            scanLine.style.display = 'block';
            snapBtn.disabled = true;
            resultOverlay.style.display = 'none';
            canvas.style.display = 'none';

            fetch('/analyze', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({}) })
            .then(r => r.json())
            .then(data => {
                setTimeout(() => {
                    const ctx = canvas.getContext('2d');
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    ctx.drawImage(video, 0, 0);

                    canvas.style.display = 'block';
                    scanLine.style.display = 'none';
                    resultOverlay.innerText = data.result;
                    resultOverlay.style.display = 'block';
                    snapBtn.disabled = false;

                    // ÁµêÊûúÁô∫Ë°®„ÅÆÈü≥Â£∞
                    speak("Ë®∫Êñ≠ÂÆå‰∫Ü„ÄÇ„Åì„Çì„Å™„ÇìÂá∫„Åæ„Åó„Åü„Åë„Å©ÔºÅ");
                }, 2500);
            });
        });
    </script>
</body>
</html>
